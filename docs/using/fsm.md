---
url: 'https://zenithgram.github.io/using/fsm.md'
description: '–°–æ–∑–¥–∞–Ω–∏–µ –¥–∏–∞–ª–æ–≥–æ–≤ –∏ –ø–æ—à–∞–≥–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Å –ø–æ–º–æ—â—å—é FSM (Finite State Machine).'
---

# –ú–∞—à–∏–Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π (FSM / –î–∏–∞–ª–æ–≥–∏)

–ß–∞—Å—Ç–æ –±–æ—Ç—É –Ω—É–∂–Ω–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ: –∏–º—è, –≤–æ–∑—Ä–∞—Å—Ç, –≥–æ—Ä–æ–¥ –∏ —Ñ–æ—Ç–æ. –†–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å —ç—Ç–æ —á–µ—Ä–µ–∑ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ `if/else` –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ—É–¥–æ–±–Ω–æ.

–í **ZenithGram** –≤—Å—Ç—Ä–æ–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ **FSM (Finite State Machine)**, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª–µ–≥–∫–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ª–∏–Ω–µ–π–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏.

## –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

–î–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å **–•—Ä–∞–Ω–∏–ª–∏—â–µ (Storage)**. –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —Å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º `FileStorage` (—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ JSON-—Ñ–∞–π–ª–∞—Ö), –Ω–æ –≤—ã –º–æ–∂–µ—Ç–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è Redis –∏–ª–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

```php
<?php
require_once __DIR__ . '/vendor/autoload.php';
use ZenithGram\ZenithGram\ZG;
use ZenithGram\ZenithGram\Bot;
use ZenithGram\ZenithGram\Storage\FileStorage;

$tg = ZG::create('–¢–û–ö–ï–ù_–ë–û–¢–ê');
$bot = new Bot($tg);

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤ Bot
$bot->setStorage(new FileStorage());

// –ò–ª–∏ –Ω–∞–ø—Ä—è–º—É—é –≤ ZG
$tg->setStorage(new FileStorage());
```

## –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã

*   `$tg->step('–Ω–∞–∑–≤–∞–Ω–∏–µ_—à–∞–≥–∞')` ‚Äî –ü–µ—Ä–µ–≤–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.
*   `$bot->onState('–Ω–∞–∑–≤–∞–Ω–∏–µ_—à–∞–≥–∞')` ‚Äî –û–±—Ä–∞–±–æ—Ç—á–∏–∫, –∫–æ—Ç–æ—Ä—ã–π —Å—Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —ç—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏.
*   `$tg->session(['–∫–ª—é—á' => '–∑–Ω–∞—á–µ–Ω–∏–µ'])` ‚Äî –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
*   `$tg->session()` ‚Äî –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ –≤—Å–µ—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
*   `$tg->endStep()` ‚Äî –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –æ—á–∏—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏.

## –ü—Ä–∏–º–µ—Ä: –ê–Ω–∫–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

–ü—Ä–∏–º–µ—Ä: —Å–æ–∑–¥–∞–¥–∏–º –±–æ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ò–º—è, –í–æ–∑—Ä–∞—Å—Ç –∏ –ì–æ—Ä–æ–¥.

### –®–∞–≥ 1: –í—Ö–æ–¥ –≤ –¥–∏–∞–ª–æ–≥

–°–æ–∑–¥–∞–µ–º –∫–æ–º–∞–Ω–¥—É, –∫–æ—Ç–æ—Ä–∞—è –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å.

```php
$bot->onBotCommand('reg', '/reg')
    ->func(function(ZG $tg) {
        $tg->reply("–î–∞–≤–∞–π—Ç–µ –∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è! –ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?");
        // –ü–µ—Ä–µ–≤–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –∏–º–µ–Ω–∏
        $tg->step('wait_name');
    });
```

### –®–∞–≥ 2: –û–±—Ä–∞–±–æ—Ç–∫–∞ –ò–º–µ–Ω–∏

–°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è `wait_name`. –û–Ω –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç –ª—é–±–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

```php
$bot->onState('wait_name')
    ->func(function(ZG $tg, string $name) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –≤ —Å–µ—Å—Å–∏—é
        $tg->session(['name' => $name]);
        
        $tg->reply("–ü—Ä–∏—è—Ç–Ω–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è, {$name}. –°–∫–æ–ª—å–∫–æ –≤–∞–º –ª–µ—Ç?");
        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É
        $tg->step('wait_age');
    });
```

### –®–∞–≥ 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ –í–æ–∑—Ä–∞—Å—Ç–∞ (—Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π)

–ó–¥–µ—Å—å –º—ã –ø—Ä–æ–≤–µ—Ä–∏–º, –≤–≤–µ–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —á–∏—Å–ª–æ.

```php
$bot->onState('wait_age')
    ->func(function(ZG $tg, string $age) {
        // –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
        if (!is_numeric($age)) {
            $tg->reply("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç —Ü–∏—Ñ—Ä–∞–º–∏.");
            return; // –ù–µ –º–µ–Ω—è–µ–º —à–∞–≥, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤ wait_age
        }

        $tg->session(['age' => $age]);
        
        $tg->reply("–û—Ç–ª–∏—á–Ω–æ! –ò–∑ –∫–∞–∫–æ–≥–æ –≤—ã –≥–æ—Ä–æ–¥–∞?");
        $tg->step('wait_city');
    });
```

### –®–∞–≥ 4: –§–∏–Ω–∞–ª

–ü–æ–ª—É—á–∞–µ–º –≥–æ—Ä–æ–¥, –≤—ã–≤–æ–¥–∏–º –∏—Ç–æ–≥ –∏ –∑–∞–≤–µ—Ä—à–∞–µ–º –¥–∏–∞–ª–æ–≥.

```php
$bot->onState('wait_city')
    ->func(function(ZG $tg, string $city) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        $tg->session(['city' => $city]);
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        $data = $tg->session();
        
        $text = "üéâ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n" .
                "üë§ –ò–º—è: {$data['name']}\n" .
                "üéÇ –í–æ–∑—Ä–∞—Å—Ç: {$data['age']}\n" .
                "üèô –ì–æ—Ä–æ–¥: {$data['city']}";
                
        $tg->reply($text);
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –æ—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        $tg->endStep();
    });
```

## –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1.  **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –û–±—Ä–∞–±–æ—Ç—á–∏–∫ `onState` –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ –æ–±—ã—á–Ω—ã–º–∏ `onText` –∏ `onCommand`. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏, –±–æ—Ç –±—É–¥–µ—Ç –∏—Å–∫–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π `onState` –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å.
2.  **–¢–∏–ø—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:** `onState` –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∫–∞–∫ —Ç–µ–∫—Å—Ç, —Ç–∞–∫ –∏ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–æ–∫ (`callback_query`), –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∑–∞–¥–∞–Ω–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏.
3.  **–û—á–∏—Å—Ç–∫–∞:** –í—Å–µ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–π—Ç–µ `endStep()`, –∫–æ–≥–¥–∞ –¥–∏–∞–ª–æ–≥ –ª–æ–≥–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω, –∏–Ω–∞—á–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "–∑–∞—Å—Ç—Ä—è–Ω–µ—Ç" –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏.



–î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –ø—Ä–∏–º–µ—Ä –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞ –∏–ª–∏ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª.

